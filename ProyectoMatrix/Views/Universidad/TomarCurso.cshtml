@model ProyectoMatrix.Models.CursoDetalleViewModel

@{
    ViewData["Title"] = $"{Model.Curso.NombreCurso} - Universidad NS";
    Layout = "_LayoutUniversidad";
}

<link rel="stylesheet" href="~/css/StylesUniversidadTC.css" asp-append-version="true" />

<div class="tomar-curso-container">
    <div class="curso-header">
        <div class="container-fluid">
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="/Universidad">Universidad NS</a></li>
                    <li class="breadcrumb-item"><a href="/Universidad/MisCursos">Mis Cursos</a></li>
                    <li class="breadcrumb-item active" aria-current="page">@Model.Curso.NombreCurso</li>
                </ol>
            </nav>

            <div class="curso-hero">
                <div class="curso-hero-left">
                    <div class="curso-chip-level" style="--nivel-color:@Model.Curso.ColorNivel">
                        <i class="fas fa-layer-group me-1" aria-hidden="true"></i>@Model.Curso.NombreNivel
                    </div>

                    <h1 class="curso-title">
                        <span class="title-accent" aria-hidden="true"></span>
                        @Model.Curso.NombreCurso
                    </h1>

                    @if (!string.IsNullOrEmpty(Model.Curso.Descripcion))
                    {
                        <p class="curso-description mb-0">@Model.Curso.Descripcion</p>
                    }

                    <div class="curso-meta-chips">
                        <span class="meta-chip">
                            <i class="fas fa-list-ol" aria-hidden="true"></i>
                            @Model.SubCursos.Count(sc => sc.Completado) / @Model.SubCursos.Count módulos
                        </span>

                        <span class="meta-chip">
                            <i class="fas fa-chart-line" aria-hidden="true"></i>
                            Progreso @Model.ProgresoGeneral.ToString("F0")%
                        </span>

                        <span class="meta-chip @(Model.CursoCompletado ? "meta-chip-success" : Model.ProgresoGeneral > 0 ? "meta-chip-primary" : "meta-chip-muted")">
                            <i class="fas @(Model.CursoCompletado ? "fa-check-circle" : Model.ProgresoGeneral > 0 ? "fa-play" : "fa-circle")" aria-hidden="true"></i>
                            @(Model.CursoCompletado ? "Completado" : Model.ProgresoGeneral > 0 ? "En progreso" : "Sin iniciar")
                        </span>
                    </div>
                </div>

                <div class="curso-hero-right">
                    <div class="stat-card">
                        <div class="stat-header">
                            <i class="fas fa-chart-pie text-primary" aria-hidden="true"></i>
                            <span>Progreso General</span>
                        </div>
                        <div class="stat-content">
                            <div class="progress-circle" data-percentage="@Model.ProgresoGeneral.ToString("F0")">
                                <div class="progress-circle-inner">
                                    <span class="progress-percentage">@Model.ProgresoGeneral.ToString("F0")%</span>
                                </div>
                            </div>
                            <div class="stat-details">
                                <small class="text-muted">
                                    @Model.SubCursos.Count(sc => sc.Completado) de @Model.SubCursos.Count módulos
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div> <!-- /curso-hero -->
        </div> <!-- /container-fluid -->
    </div> <!-- /curso-header -->
    <!-- Contenido Principal -->
    <div class="container-fluid">
        <div class="row">
            <!-- Lista de SubCursos -->
            <div class="col-xl-8">
                <div class="subcursos-container">
                    <div class="subcursos-header">
                        <h4>
                            <i class="fas fa-list-ol me-2" aria-hidden="true"></i>
                            Módulos del Curso
                        </h4>
                        <p class="text-muted">
                            Completa los módulos en orden para desbloquear el siguiente contenido
                        </p>
                    </div>

                    @if (Model.SubCursos.Any())
                    {
                        <div class="subcursos-list">
                            @for (int i = 0; i < Model.SubCursos.Count; i++)
                            {
                                var subCurso = Model.SubCursos[i];
                                var isLocked = !subCurso.PuedeAcceder;
                                var isCompleted = subCurso.Completado;
                                var isInProgress = subCurso.PorcentajeVisto > 0 && !subCurso.Completado;

                                <div class="subcurso-item @(isLocked ? "locked" : "") @(isCompleted ? "completed" : "") @(isInProgress ? "in-progress" : "")">
                                    <div class="subcurso-card">
                                        <!-- Número de Orden -->
                                        <div class="subcurso-number">
                                            @if (isCompleted)
                                            {
                                                <i class="fas fa-check-circle text-success" aria-hidden="true"></i>
                                            }
                                            else if (isLocked)
                                            {
                                                <i class="fas fa-lock text-muted" aria-hidden="true"></i>
                                            }
                                            else
                                            {
                                                <span class="number">@subCurso.Orden</span>
                                            }
                                        </div>

                                        <!-- Contenido del SubCurso -->
                                        <div class="subcurso-content">
                                            <div class="subcurso-header">
                                                <h5 class="subcurso-title">@subCurso.NombreSubCurso</h5>
                                                <div class="subcurso-badges">
                                                    @if (subCurso.EsObligatorio)
                                                    {
                                                        <span class="badge bg-danger">Obligatorio</span>
                                                    }
                                                    @if (subCurso.RequiereEvaluacion)
                                                    {
                                                        <span class="badge bg-info">Con Evaluación</span>
                                                    }
                                                </div>
                                            </div>

                                            @if (!string.IsNullOrEmpty(subCurso.Descripcion))
                                            {
                                                <p class="subcurso-description">@subCurso.Descripcion</p>
                                            }

                                            <!-- Información del Video -->
                                            <div class="subcurso-meta">
                                                <div class="meta-item">
                                                    <i class="fas fa-play-circle text-primary me-1" aria-hidden="true"></i>
                                                    <span>Duración: @subCurso.DuracionFormateada</span>
                                                </div>
                                                @if (subCurso.RequiereEvaluacion)
                                                {
                                                    <div class="meta-item">
                                                        <i class="fas fa-clipboard-check text-info me-1" aria-hidden="true"></i>
                                                        <span>Puntaje mínimo: @subCurso.PuntajeMinimo%</span>
                                                    </div>
                                                }
                                                @if (!string.IsNullOrEmpty(subCurso.ArchivoPDF))
                                                {
                                                    <div class="meta-item">
                                                        <i class="fas fa-file-pdf text-danger me-1" aria-hidden="true"></i>
                                                        <span>Material adicional disponible</span>
                                                    </div>
                                                }
                                            </div>

                                            <!-- Progreso Individual -->
                                            @if (!isLocked)
                                            {
                                                <div class="subcurso-progress">
                                                    <div class="d-flex justify-content-between mb-1">
                                                        <small class="text-muted">Progreso</small>
                                                        <small class="text-muted">@subCurso.PorcentajeVisto.ToString("F0")%</small>
                                                    </div>
                                                    <div class="progress progress-sm">
                                                        <div class="progress-bar @(isCompleted ? "bg-success" : "bg-primary")"
                                                             style="width: @($"{subCurso.PorcentajeVisto.ToString("0.##", System.Globalization.CultureInfo.InvariantCulture)}%")">
                                                        </div>
                                                    </div>
                                                    @if (subCurso.TiempoTotalVisto > 0)
                                                    {
                                                        <small class="text-muted">
                                                            Tiempo visto: @TimeSpan.FromSeconds(subCurso.TiempoTotalVisto).ToString(@"mm\:ss")
                                                        </small>
                                                    }
                                                </div>
                                            }

                                            <!-- Estado de Evaluación -->
                                            @if (subCurso.UltimoIntento != null && subCurso.RequiereEvaluacion)
                                            {
                                                <div class="evaluacion-estado mt-2">
                                                    <div class="alert @(subCurso.UltimoIntento.Aprobado ? "alert-success" : "alert-warning") py-2">
                                                        <small>
                                                            <strong>Última evaluación:</strong>
                                                            @subCurso.UltimoIntento.PorcentajeCalificacion.ToString("F1")%
                                                            (@subCurso.UltimoIntento.CalificacionTexto)
                                                            - Intento @subCurso.UltimoIntento.NumeroIntento
                                                        </small>
                                                    </div>
                                                </div>
                                            }
                                        </div>

                                        <!-- Acciones -->
                                        <div class="subcurso-actions">
                                            @if (isLocked)
                                            {
                                                <button class="btn btn-outline-secondary btn-sm" disabled>
                                                    <i class="fas fa-lock me-1" aria-hidden="true"></i>Bloqueado
                                                </button>
                                                <small class="text-muted d-block mt-1">
                                                    Completa el módulo anterior
                                                </small>
                                            }
                                            else
                                            {
                                                <a asp-controller="Universidad"
                                                   asp-action="TomarSubCurso"
                                                   asp-route-subCursoId="@subCurso.SubCursoID"
                                                   class="btn btn-universidad btn-sm">
                                                    @if (isCompleted)
                                                    {
                                                        <i class="fas fa-eye me-1" aria-hidden="true"></i>
                                                        <text>Revisar</text>
                                                    }
                                                    else if (isInProgress)
                                                    {
                                                        <i class="fas fa-play me-1" aria-hidden="true"></i>
                                                        <text>Continuar</text>
                                                    }
                                                    else
                                                    {
                                                        <i class="fas fa-play-circle me-1" aria-hidden="true"></i>
                                                        <text>Comenzar</text>
                                                    }
                                                </a>

                                                
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="empty-state text-center py-5">
                            <i class="fas fa-video fa-3x text-muted mb-3" aria-hidden="true"></i>
                            <h5 class="text-muted">Sin contenido disponible</h5>
                            <p class="text-muted">Este curso aún no tiene módulos configurados.</p>
                        </div>
                    }
                </div>
            </div>

            <!-- Sidebar de Información -->
            <div class="col-xl-4">
                <div class="info-card mb-4">
                    <div class="info-card-body">
                        <div class="info-item">
                            <div class="info-label">Total de módulos</div>
                            <div class="info-value">@Model.SubCursos.Count</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Módulos completados</div>
                            <div class="info-value">@Model.SubCursos.Count(sc => sc.Completado)</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Progreso general</div>
                            <div class="info-value">@Model.ProgresoGeneral.ToString("F1")%</div>
                        </div>
                        @if (Model.SubCursosBloqueados > 0)
                        {
                            <div class="info-item">
                                <div class="info-label">Módulos bloqueados</div>
                                <div class="info-value text-warning">@Model.SubCursosBloqueados</div>
                            </div>
                        }
                        <div class="info-item">
                            <div class="info-label">Estado del curso</div>
                            <div class="info-value">
                                @if (Model.CursoCompletado)
                                {
                                    <span class="badge bg-success">Completado</span>
                                    <br />
                                    <a asp-controller="Universidad"
                                       asp-action="DescargarCertificado"
                                       asp-route-id="@Model.Curso.CursoID"
                                       class="btn btn-success btn-sm mt-2">
                                        <i class="fas fa-certificate me-2" aria-hidden="true"></i> Descargar Certificado
                                    </a>
                                }
                                else if (Model.ProgresoGeneral > 0)
                                {
                                    <span class="badge bg-primary">En Progreso</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">Sin Iniciar</span>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div> <!-- /col-xl-4 -->
        </div> <!-- /row -->
        <!-- Bloques a ancho completo bajo el grid -->
        <div class="info-card mb-4">
            <div class="info-card-header">
                <h6><i class="fas fa-chart-line me-2" aria-hidden="true"></i>Tu Progreso</h6>
            </div>
            <div class="info-card-body">
                <div class="progress-detailed">
                    @foreach (var subCurso in Model.SubCursos.Take(5))
                    {
                        <div class="progress-item">
                            <div class="progress-item-header">
                                <span class="progress-item-title">@subCurso.NombreSubCurso</span>
                                <span class="progress-item-percentage">@subCurso.PorcentajeVisto.ToString("F0")%</span>
                            </div>
                            <div class="progress progress-xs">
                                <div class="progress-bar @(subCurso.Completado ? "bg-success" : "bg-primary")"
                                     style="width: @($"{subCurso.PorcentajeVisto.ToString("0.##", System.Globalization.CultureInfo.InvariantCulture)}%")">
                                </div>
                            </div>
                        </div>
                    }
                    @if (Model.SubCursos.Count > 5)
                    {
                        <div class="text-center mt-2">
                            <small class="text-muted">Y @(Model.SubCursos.Count - 5) módulos más...</small>
                        </div>
                    }
                </div>
            </div>
        </div>

        @{
            var proximoSubCurso = Model.SubCursos.FirstOrDefault(sc => !sc.Completado && sc.PuedeAcceder);
        }
        @if (proximoSubCurso != null)
        {
            <div class="info-card mb-4">
                <div class="info-card-header">
                    <h6><i class="fas fa-arrow-right me-2" aria-hidden="true"></i>Próximo Paso</h6>
                </div>
                <div class="info-card-body">
                    <div class="next-step">
                        <h6 class="next-step-title">@proximoSubCurso.NombreSubCurso</h6>
                        <p class="next-step-description text-muted">@proximoSubCurso.Descripcion</p>
                        <div class="next-step-meta mb-3">
                            <small class="text-muted">
                                <i class="fas fa-clock me-1" aria-hidden="true"></i>Duración: @proximoSubCurso.DuracionFormateada
                            </small>
                        </div>
                        <a asp-controller="Universidad"
                           asp-action="TomarSubCurso"
                           asp-route-subCursoId="@proximoSubCurso.SubCursoID"
                           class="btn btn-universidad btn-sm w-100">
                            @if (proximoSubCurso.PorcentajeVisto > 0)
                            {
                                <i class="fas fa-play me-2" aria-hidden="true"></i>
                                <text>Continuar Módulo</text>
                            }
                            else
                            {
                                <i class="fas fa-play-circle me-2" aria-hidden="true"></i>
                                <text>Comenzar Módulo</text>
                            }
                        </a>
                    </div>
                </div>
            </div>
        }

        <div class="info-card">
            <div class="info-card-header">
                <h6><i class="fas fa-lightbulb me-2" aria-hidden="true"></i>Consejos</h6>
            </div>
            <div class="info-card-body">
                <div class="tips-list">
                    <div class="tip-item">
                        <i class="fas fa-check-circle text-success me-2" aria-hidden="true"></i>
                        <small>Completa los módulos en orden secuencial</small>
                    </div>
                    <div class="tip-item">
                        <i class="fas fa-clock text-info me-2" aria-hidden="true"></i>
                        <small>Dedica tiempo suficiente para ver cada video completo</small>
                    </div>
                    <div class="tip-item">
                        <i class="fas fa-file-pdf text-danger me-2" aria-hidden="true"></i>
                        <small>Descarga los materiales PDF para consulta posterior</small>
                    </div>
                    <div class="tip-item">
                        <i class="fas fa-graduation-cap text-warning me-2" aria-hidden="true"></i>
                        <small>Las evaluaciones requieren al menos @((Model.SubCursos.FirstOrDefault()?.PuntajeMinimo ?? 70))% para aprobar</small>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- /container-fluid -->
</div> <!-- /tomar-curso-container -->
@section Scripts {
    <script>
        document.querySelectorAll('.progress-circle').forEach(el=>{
          const p = parseFloat(el.dataset.percentage || '0');
          el.style.setProperty('--percentage', Math.max(0, Math.min(100, p)));
        });
    </script>
}
