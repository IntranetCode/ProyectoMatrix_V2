@model List<ProyectoMatrix.Models.MenuModel>

@{
    Layout = null;
    ViewData["Title"] = "Intranet - NS Group";
    var nombreUsuario = Context.Session.GetString("Username") ?? "Invitado";
    var nombreEmpresa = Context.Session.GetString("EmpresaNombre") ?? "NS Group";
    var logoEmpresa = Context.Session.GetString("EmpresaLogo") ?? "default-logo.png";
    var empresaId = Context.Session.GetString("EmpresaId") ?? "1";

    // Configuración de archivos CSS por empresa
    var cssEmpresaFile = empresaId switch
    {
        "1" => "LoginNutriservicios.css",
        "2" => "LoginNS_Equipo.css",
        "3" => "LoginBSP.css",
        "4" => "LoginHypor.css",
        _ => "site.css"
    };

    // Enlaces SharePoint configurables
    var enlacesMejoraContina = "https://nsgroupmx.sharepoint.com/sites/ProcesosyMejoraContinua";
    var enlacesCompras = "https://forms.office.com/r/K7u3UMVVKi";
    var enlacesLogistica = "https://forms.office.com/r/77fwUyxuE0";
    var enlacesEmbarques = "https://forms.office.com/r/MRjsPtpUrv";
    var enlacesHelpDesk = "https://forms.office.com/r/nBWtdqGsUm";

    // ✅ FIX: Construir URL correctamente
    var currentUrl = $"{Context.Request.Scheme}://{Context.Request.Host}{Context.Request.Path}";
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>@ViewData["Title"]</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- CSS Orden de carga optimizado -->
    <link rel="stylesheet" href="~/css/globals/variables.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/components/navbar.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/components/cards.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/pages/dashboard.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/@cssEmpresaFile" asp-append-version="true" />
    <link href="~/css/stylesMenuIndex.css" rel="stylesheet" />
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

    <!-- Preload de recursos críticos -->
    <link rel="preload" href="~/js/dashboard.js" as="script" />
    <link rel="preload" href="~/Imagenes/logo-universidad-ns.png" as="image" />
</head>

<body data-empresa="@empresaId">
    <!-- Skip Link para accesibilidad -->
    <a href="#main-content" class="skip-link visually-hidden">Saltar al contenido principal</a>

    <!-- Main Content Wrapper -->
    <div class="main-wrapper">
        <!-- Top Navigation -->
        <nav class="top-navbar" role="navigation" aria-label="Navegación principal">
            <div class="navbar-content">
                <div class="navbar-left">
                    <a href="#" class="navbar-brand">
                        @if (!string.IsNullOrEmpty(logoEmpresa) && logoEmpresa != "default-logo.png")
                        {
                            <img src="~/imagenes/@logoEmpresa"
                                 alt="Logo de @nombreEmpresa"
                                 class="navbar-logo"
                                 loading="lazy" />
                        }
                        else
                        {
                            <i class="fas fa-building" aria-hidden="true"></i>
                        }
                        <span class="navbar-title">@nombreEmpresa</span>
                    </a>

                    <div class="navbar-links" role="menubar">
                        <a href="https://nsgroup.com.mx/index.html" class="navbar-link" role="menuitem">Página NS Group</a>
                        <a href="#" class="navbar-link" role="menuitem">Recursos Humanos</a>
                        <a href="#" class="navbar-link" role="menuitem">Directorio</a>
                    </div>
                </div>

                <div class="navbar-right">
                    <div class="user-menu">
                        <button class="user-toggle"
                                id="userToggle"
                                aria-expanded="false"
                                aria-haspopup="true"
                                aria-label="Menú de usuario">
                            <div class="user-avatar" aria-hidden="true">
                                @(nombreUsuario.Substring(0, 1).ToUpper())
                            </div>
                            <div class="user-info">
                                <div class="user-name">@nombreUsuario</div>
                                <div class="user-role">Colaborador</div>
                            </div>
                            <i class="fas fa-chevron-down" aria-hidden="true"></i>
                        </button>

                        <div class="user-dropdown"
                             id="userDropdownMenu"
                             role="menu"
                             aria-labelledby="userToggle">
                            <a href="#" class="dropdown-item" role="menuitem">
                                <i class="fas fa-user" aria-hidden="true"></i>
                                Mi Perfil
                            </a>
                            <a href="#" class="dropdown-item" role="menuitem">
                                <i class="fas fa-cog" aria-hidden="true"></i>
                                Configuración
                            </a>
                            <a href="#" class="dropdown-item" role="menuitem">
                                <i class="fas fa-bell" aria-hidden="true"></i>
                                Notificaciones
                            </a>
                            <a href="#" class="dropdown-item" role="menuitem">
                                <i class="fas fa-question-circle" aria-hidden="true"></i>
                                Ayuda
                            </a>
                            <a href="/Login/Logout" class="dropdown-item">
                                <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
                                Cerrar Sesión
                            </a>

                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content" id="main-content" role="main">
            <!-- Welcome Section -->
            <section class="welcome-section" aria-labelledby="welcome-title">
                <div class="welcome-content">
                    <h1 id="welcome-title" class="welcome-title">¡Hola, @nombreUsuario!</h1>
                    <p class="welcome-subtitle">
                        Bienvenido al portal interno de @nombreEmpresa.
                        Accede a recursos, capacitaciones y herramientas internas.
                    </p>
                </div>
            </section>

            <!-- Quick Actions Grid -->
            <section class="quick-actions" aria-label="Módulos disponibles">
                @if (Model != null && Model.Any())
                {
                    @foreach (var menu in Model)
                    {
                        var cssClass = GetCssClassForMenu(menu.Nombre);
                        var isUniversidad = menu.Nombre.Contains("Universidad", StringComparison.OrdinalIgnoreCase);

                        <article class="action-card @cssClass @(isUniversidad ? "with-logo" : "")"
                                 data-href="@menu.Url"
                                 role="button"
                                 tabindex="0">
                            <div class="action-icon" aria-hidden="true">
                                <i class="fas @menu.Icono"></i>
                            </div>
                            <h2 class="action-title">@menu.Nombre</h2>
                            @* ✅ FIX: Verificar si Descripcion existe y no está vacía *@
                            @if (!string.IsNullOrEmpty(menu.Descripcion))
                            {
                                <p class="action-description">@menu.Descripcion</p>
                            }
                            else
                            {
                                <p class="action-description">Accede a @menu.Nombre</p>
                            }
                        </article>
                    }
                }

                <!-- Enlaces SharePoint como tarjetas adicionales -->
                <article class="action-card mejora"
                         data-href-external="@enlacesMejoraContina"
                         role="button"
                         tabindex="0">
                    <div class="external-link-badge">SharePoint</div>
                    <div class="action-icon" aria-hidden="true">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h2 class="action-title">Mejora Continua</h2>
                    <p class="action-description">Procesos y mejora continua del grupo</p>
                </article>

                <article class="action-card compras"
                         data-href-external="@enlacesCompras"
                         role="button"
                         tabindex="0">
                    <div class="external-link-badge">Forms</div>
                    <div class="action-icon" aria-hidden="true">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <h2 class="action-title">Compras</h2>
                    <p class="action-description">Solicitudes y gestión de compras</p>
                </article>

                <article class="action-card logistica"
                         data-href-external="@enlacesLogistica"
                         role="button"
                         tabindex="0">
                    <div class="external-link-badge">Forms</div>
                    <div class="action-icon" aria-hidden="true">
                        <i class="fas fa-truck"></i>
                    </div>
                    <h2 class="action-title">Logística</h2>
                    <p class="action-description">Gestión logística y entregas</p>
                </article>

                <article class="action-card embarques"
                         data-href-external="@enlacesEmbarques"
                         role="button"
                         tabindex="0">
                    <div class="external-link-badge">Forms</div>
                    <div class="action-icon" aria-hidden="true">
                        <i class="fas fa-ship"></i>
                    </div>
                    <h2 class="action-title">Embarques</h2>
                    <p class="action-description">Control de embarques y envíos</p>
                </article>

                <article class="action-card helpdesk"
                         data-href-external="@enlacesHelpDesk"
                         role="button"
                         tabindex="0">
                    <div class="external-link-badge">Forms</div>
                    <div class="action-icon" aria-hidden="true">
                        <i class="fas fa-headset"></i>
                    </div>
                    <h2 class="action-title">Help Desk</h2>
                    <p class="action-description">Soporte técnico y asistencia</p>
                </article>
            </section>
        </main>
    </div>

    <!-- Scripts -->
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/dashboard.js" asp-append-version="true"></script>

    <!-- ✅ FIX: Schema markup corregido -->
    <script type="application/ld+json">
        {
            "@@context": "https://schema.org", 
            "@@type": "WebApplication",
            "name": "Intranet NS Group",
            "description": "Portal interno de @nombreEmpresa",
            "url": "@currentUrl",
            "applicationCategory": "BusinessApplication",
            "operatingSystem": "Web"
        }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
          const cards = document.querySelectorAll('.action-card');

          cards.forEach(function (card) {
            card.addEventListener('click', function () {
              const url = card.getAttribute('data-href') || card.getAttribute ('data-href-external');
              if (url && url !== "#") {
                  if(card.hasAttribute('data-href-external')){
                      window.open(url, '_blank');
                  }else{
                      window.location.href = url;
                  }
              }
            });

            card.addEventListener('keydown', function (e) {
              if (e.key === 'Enter') {
                const url = card.getAttribute('data-href') || card.getAttribute ('data-href-external');
                if (url && url !== "#") {
                    if(card.hasAttribute('data-href-external')){
                        window.open(url, '_blank');
                        }else{
                            window.location.href = url;
                        }
                }
              }
              
            });
          });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const toggleBtn = document.getElementById('userToggle');
            const dropdown = document.getElementById('userDropdownMenu');

            if (!toggleBtn || !dropdown) return;

            toggleBtn.addEventListener('click', function (e) {
                e.stopPropagation();
                dropdown.classList.toggle('show');
            });

            document.addEventListener('click', function (e) {
                if (!dropdown.contains(e.target) && !toggleBtn.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });
        });
    </script>

    <script>
        // Reemplaza la URL del login con la del index en el historial
        if (window.history.replaceState) {
            window.history.replaceState(null, '', '/Menu/Index');
        }
    </script>

 

</body>
</html>

@functions {
    // ✅ Helper para determinar la clase CSS según el nombre del menú
    private string GetCssClassForMenu(string menuNombre)
    {
        if (string.IsNullOrEmpty(menuNombre)) return "";

        var menuLower = menuNombre.ToLowerInvariant();

        return menuLower switch
        {
            var x when x.Contains("universidad") => "universidad",
            var x when x.Contains("lider") => "lider",
            var x when x.Contains("comunicados") => "comunicados",
            var x when x.Contains("proyectos") => "proyectos",
            _ => ""
        };
    }
}