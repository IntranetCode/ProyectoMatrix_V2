@using ProyectoMatrix.Models
@model Proyecto
@{
    var rol = Context.Session.GetString("Rol") ?? "Colaborador";
    Layout = rol == "Administrador" ? "~/Views/Shared/_Layout.cshtml" : "~/Views/Shared/_LayoutComunicados.cshtml";
}

<link href="~/css/stylesProyectosCrear.css" rel="stylesheet" />

<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0"><i class="fas fa-plus-circle me-2 text-primary"></i>Crear Nuevo Proyecto</h1>
            <p class="text-muted">Completa la información del proyecto y adjunta los archivos necesarios</p>
        </div>
        <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Volver a Proyectos
        </a>
    </div>

    @*CAPTURAR ERRORES

    <div asp-validation-summary="All" class="alert alert-danger"></div>

    @if (ViewBag.ModelErrors != null)
    {
        <div class="alert alert-warning">
            <ul>
                @foreach (var e in (IEnumerable<string>)ViewBag.ModelErrors)
                {
                    <li>@e</li>
                }
            </ul>
        </div>
    }*@



    <!-- Formulario -->
    <form id="formCrearProyecto" asp-action="Crear" method="post" enctype="multipart/form-data" class="form-container">
        @Html.AntiForgeryToken()
        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

        <!-- Sección: Información Básica -->
        <div class="form-section">
            <h5><i class="fas fa-info-circle me-2"></i>Información Básica</h5>
            <div class="row">
                <div class="col-md-8">
                    <div class="mb-3">
                        <label asp-for="NombreProyecto" class="form-label">
                            <i class="fas fa-project-diagram me-1"></i>Nombre del Proyecto *
                        </label>
                        <input asp-for="NombreProyecto" class="form-control form-control-lg"
                               placeholder="Ingrese el nombre del proyecto" required />
                        <span asp-validation-for="NombreProyecto" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label asp-for="CodigoProyecto" class="form-label">
                            <i class="fas fa-hashtag me-1"></i>Código del Proyecto
                        </label>
                        <input asp-for="CodigoProyecto" class="form-control"
                               placeholder="PRY-2025-001" />
                        <span asp-validation-for="CodigoProyecto" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-8">
                    <div class="mb-3">
                        <label asp-for="Cliente" class="form-label">
                            <i class="fas fa-building me-1"></i>Cliente
                        </label>
                        <input asp-for="Cliente" class="form-control"
                               placeholder="Ingrese el nombre del cliente" />
                        <span asp-validation-for="Cliente" class="text-danger"></span>
                    </div>

                </div>
            </div>

            <div class="row">
                <div class="col-md-8">
                    <div class="mb-3">
                        <label asp-for="Ubicacion" class="form-label">
                            <i class="fas fa-map-marker-alt me-1"></i> Ubicacion del proyecto
                        </label>
                        <input asp-for="Ubicacion" class="form-control"
                        placeholder="Ingrese la ubicacion del proyecto"/>
                        <span asp-validation-for="Ubicacion" class="text-danger"></span>
                    </div>

                </div>
            </div>

            <div class="row">
                <div class="col-md-8">
                    <div class="mb-3">
                        <label asp-for="Tipo" class="form-label">
                            <i class="fas fa-tag me-1"></i>
                            Tipo
                        </label>
                        <input asp-for="Tipo" class="form-control"
                               placeholder="Ingrese el tipo de proyecto a desarrollar" />
                        <span asp-validation-for="Tipo" class="text-danger"></span>
                    </div>

                </div>
            </div>

            <div class="mb-3">
                <label asp-for="Descripcion" class="form-label">
                    <i class="fas fa-align-left me-1"></i>Descripción
                </label>
                <textarea asp-for="Descripcion" class="form-control" rows="3"
                          placeholder="Describe brevemente el proyecto, sus objetivos y alcance"></textarea>
                <span asp-validation-for="Descripcion" class="text-danger"></span>
            </div>
        </div>

        <!-- Sección: Estado y Prioridad -->
        <div class="form-section">
            <h5><i class="fas fa-cogs me-2"></i>Estado y Prioridad</h5>
            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label asp-for="Estado" class="form-label">
                            <i class="fas fa-tasks me-1"></i>Estado
                        </label>
                        <select asp-for="Estado" class="form-select">
                            @foreach (EstadoProyecto estado in Enum.GetValues<EstadoProyecto>())
                            {
                                <option value="@estado">@estado.ObtenerNombreEstado()</option>
                            }
                        </select>
                        <span asp-validation-for="Estado" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label asp-for="Prioridad" class="form-label">
                            <i class="fas fa-flag me-1"></i>Prioridad
                        </label>
                        <select asp-for="Prioridad" class="form-select">
                            @foreach (PrioridadProyecto prioridad in Enum.GetValues<PrioridadProyecto>())
                            {
                                <option value="@prioridad">@prioridad.ObtenerNombrePrioridad()</option>
                            }
                        </select>
                        <span asp-validation-for="Prioridad" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label asp-for="Progreso" class="form-label">
                            <i class="fas fa-chart-line me-1"></i>Progreso Inicial (%)
                        </label>
                        <input asp-for="Progreso" type="range" class="form-range" min="0" max="100"
                               id="progresoSlider" oninput="updateProgressValue(this.value)" />
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">0%</small>
                            <span id="progresoValue" class="badge bg-primary">@Model.Progreso%</span>
                            <small class="text-muted">100%</small>
                        </div>
                        <span asp-validation-for="Progreso" class="text-danger"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección: Fechas y Responsables -->
        <div class="form-section">
            <h5><i class="fas fa-calendar-alt me-2"></i>Fechas y Responsables</h5>
            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label asp-for="FechaInicio" class="form-label">
                            <i class="fas fa-play-circle me-1"></i>Fecha de Inicio
                        </label>
                        <input asp-for="FechaInicio" type="date" class="form-control" />
                        <span asp-validation-for="FechaInicio" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label asp-for="FechaFinPrevista" class="form-label">
                            <i class="fas fa-flag-checkered me-1"></i>Fecha de Entrega Prevista
                        </label>
                        <input asp-for="FechaFinPrevista" type="date" class="form-control" />
                        <span asp-validation-for="FechaFinPrevista" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label asp-for="ResponsableProyecto" class="form-label">
                            <i class="fas fa-user-tie me-1"></i>Responsable del Proyecto
                        </label>
                        <input asp-for="ResponsableProyecto" class="form-control"
                               placeholder="Nombre del responsable" />
                        <span asp-validation-for="ResponsableProyecto" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label asp-for="Presupuesto" class="form-label">
                            <i class="fas fa-dollar-sign me-1"></i>Presupuesto
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input asp-for="Presupuesto" type="number" class="form-control"
                                   placeholder="0.00" step="0.01" />
                        </div>
                        <span asp-validation-for="Presupuesto" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label asp-for="Tags" class="form-label">
                            <i class="fas fa-tags me-1"></i>Tags/Etiquetas
                        </label>
                        <input asp-for="Tags" class="form-control"
                               placeholder="desarrollo,web,cliente-x" />
                        <small class="form-text text-muted">Separar por comas</small>
                        <span asp-validation-for="Tags" class="text-danger"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección: Archivo Adjunto -->
        <div class="form-section">
            <h5><i class="fas fa-paperclip me-2"></i>Documento inicial del proyecto (opcional)</h5>

            <div class="file-upload-container text-center p-4 border rounded"
                 id="zonaDrop"
                 style="cursor:pointer; border-style:dashed;"
                 ondragover="event.preventDefault()"
                 ondrop="return false;">
                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                <h5 class="text-muted mb-1">Arrastra el archivo aquí o usa el botón</h5>
                <p class="text-muted mb-0">PDF, DOC(X), XLS(X) – máx 10MB</p>


                <input type="file" name="archivo" id="archivo" class="d-none"
                       accept=".pdf,.doc,.docx,.xls,.xlsx" />

                <!-- Botón que abre el selector -->
                <label for="archivo" class="btn btn-outline-primary mt-3 mb-0">
                    <i class="fas fa-folder-open me-1"></i> Seleccionar archivo
                </label>
            </div>

            <div id="fileInfo" class="mt-3" style="display:none;">
                <div class="alert alert-info d-flex align-items-center">
                    <i class="fas fa-file-alt fa-2x me-3"></i>
                    <div>
                        <strong id="fileName"></strong><br />
                        <small id="fileSize" class="text-muted"></small>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger ms-auto" onclick="limpiarArchivo()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Sección: Observaciones -->
        <div class="form-section">
            <h5><i class="fas fa-sticky-note me-2"></i>Observaciones Adicionales</h5>
            <textarea asp-for="Observaciones" class="form-control" rows="4"
                      placeholder="Agrega cualquier información adicional, notas especiales o comentarios sobre el proyecto"></textarea>
            <span asp-validation-for="Observaciones" class="text-danger"></span>
        </div>

        <!-- Botones de Acción -->
        <div class="text-center pt-3 border-top">
    <button type="submit" class="btn-crear-proyecto">
      <i class="fas fa-save me-1"></i> Crear Proyecto
    </button>
            <a href="@Url.Action("Index")" class="btn btn-outline-secondary btn-action">
                <i class="fas fa-times me-1"></i>Cancelar
            </a>
        </div>
    </form>
</div>
@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Referencias (coinciden con tu HTML)
            const contenedor = document.getElementById('zonaDrop');       // ⬅️ zonaDrop (no fileUploadContainer)
            const input = document.getElementById('archivo');
            const info = document.getElementById('fileInfo');
            const lblNombre = document.getElementById('fileName');
            const lblTamano = document.getElementById('fileSize');
            const form = document.getElementById('formCrearProyecto');
            const btnSubmit = form ? form.querySelector('button[type="submit"]') : null;

            if (!contenedor || !input || !info || !lblNombre || !lblTamano) {
                console.warn('Faltan IDs en el HTML');
                return;
            }

            // Utilidades
            const MAX_MB = 10;
            const EXT = ['pdf','doc','docx','xls','xlsx'];
            const bytesATexto = b => (b/1048576)>=1 ? (b/1048576).toFixed(2)+' MB' : (b/1024).toFixed(0)+' KB';
            const extValida = n => { const p=n.lastIndexOf('.'); return p>=0 && EXT.includes(n.substring(p+1).toLowerCase()); };

            function mostrarInfoArchivo(f){
                lblNombre.textContent = f.name;
                lblTamano.textContent = bytesATexto(f.size);
                info.style.display = 'block';
            }
            function limpiarArchivo(){
                input.value = '';
                info.style.display = 'none';
            }
            window.limpiarArchivo = limpiarArchivo; // para el botón "X"

            // Click en el contenedor → abrir selector, excepto si fue el label
            contenedor.addEventListener('click', function (e) {
                if (!e.target.closest('label')) input.click();
            });

            // Drag & Drop sencillo
            contenedor.addEventListener('dragover', e => { e.preventDefault(); contenedor.classList.add('dragover'); });
            contenedor.addEventListener('dragleave', e => { e.preventDefault(); contenedor.classList.remove('dragover'); });
            contenedor.addEventListener('drop', e => {
                e.preventDefault(); contenedor.classList.remove('dragover');
                const files = e.dataTransfer?.files;
                if (!files || files.length === 0) return;
                const f = files[0];
                if (!extValida(f.name)) { alert('Formato no permitido: ' + EXT.join(', ')); return; }
                if (f.size > MAX_MB * 1024 * 1024) { alert(`Máximo ${MAX_MB} MB.`); return; }
                const dt = new DataTransfer(); dt.items.add(f); input.files = dt.files;
                mostrarInfoArchivo(f);
            });

            // Cambio por selector
            input.addEventListener('change', function () {
                const f = this.files && this.files[0];
                if (!f) { limpiarArchivo(); return; }
                if (!extValida(f.name)) { alert('Formato no permitido.'); limpiarArchivo(); return; }
                if (f.size > MAX_MB * 1024 * 1024) { alert(`Máx ${MAX_MB} MB.`); limpiarArchivo(); return; }
                mostrarInfoArchivo(f);
            });

            // Autogenerar Código cuando salgas de Nombre (usa tus asp-for actuales)
            const nombreInput = document.getElementById('NombreProyecto');
            const codigoInput = document.getElementById('CodigoProyecto');
            if (nombreInput && codigoInput) {
                nombreInput.addEventListener('blur', function(){
                    if (codigoInput.value.trim() === '' && this.value.trim() !== '') {
                        const d = new Date();
                        const y = d.getFullYear();
                        const m = String(d.getMonth()+1).padStart(2,'0');
                        const rnd = String(Math.floor(Math.random()*999)+1).padStart(3,'0');
                        codigoInput.value = `PRY-${y}${m}-${rnd}`;
                    }
                });
            }

            // Validación al enviar (opcional)
            if (form) {
                form.addEventListener('submit', function(e){
                    const f = input.files && input.files[0];
                    if (f) {
                        if (!extValida(f.name)) { e.preventDefault(); alert('Formato no permitido.'); return; }
                        if (f.size > MAX_MB * 1024 * 1024) { e.preventDefault(); alert(`Máx ${MAX_MB} MB.`); return; }
                    }
                });
            }
        });
    </script>
}
